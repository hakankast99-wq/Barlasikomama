<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barlas' Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { -ms-overflow-style: none; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-item-new { animation: fadeIn 0.5s ease-out; }
        .prose { max-width: none; }

        #copyFeedback {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

    </style>

    <!-- App icon voor mobiele apparaten (PWA) -->
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/059669/ffffff?text=Barlasiko">
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans transition-colors duration-300">

    <!-- Welcome Scherm -->
    <div id="welcomeScreen" class="container mx-auto max-w-lg p-4 min-h-screen flex flex-col justify-center items-center text-center">
        <div class="glass-card p-8 rounded-2xl shadow-2xl w-full">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">Welkom bij Barlas' Tracker</h1>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Synchroniseer de data tussen meerdere apparaten.</p>
            <div id="welcomeActions">
                <button id="createFamilyBtn" class="w-full bg-blue-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-blue-600 transition-colors mb-4 text-lg">
                    Nieuwe Familie Starten
                </button>
                <div class="space-y-2">
                    <input id="familyIdInput" type="text" placeholder="Voer Familie ID in" class="w-full p-3 border border-gray-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="joinFamilyBtn" class="w-full bg-green-500 text-white font-semibold px-4 py-3 rounded-lg hover:bg-green-600 transition-colors">
                        Deelnemen aan Familie
                    </button>
                </div>
            </div>
            <p id="joinError" class="text-red-500 mt-2 hidden">ID niet gevonden.</p>
            <p id="initError" class="text-red-500 font-semibold mt-4 hidden"></p>
        </div>
    </div>

    <!-- Hoofd App -->
    <div id="app" class="container mx-auto max-w-lg p-4 min-h-screen hidden">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Barlas' Tracker</h1>
            <button id="darkModeToggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition-colors">
                <svg id="sunIcon" class="text-slate-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg id="moonIcon" class="hidden text-slate-200" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>
        <div id="loadingApp" class="text-center text-slate-500 dark:text-slate-400 py-10" style="display: none;">
            <p>App aan het laden...</p>
        </div>

        <div id="appContent" class="hidden">
            <div class="mb-4 p-3 glass-card rounded-lg text-center">
                <p class="text-sm text-slate-600 dark:text-slate-300">Familie ID: <strong id="familyIdDisplay" class="font-mono"></strong></p>
                <div class="mt-2 flex justify-center items-center space-x-4">
                    <button id="copyFamilyId" class="text-blue-500 text-sm hover:underline">Kopieer</button>
                    <button id="leaveFamily" class="text-yellow-600 dark:text-yellow-400 text-sm hover:underline">Verlaat</button>
                    <button id="deleteFamily" class="text-red-500 text-sm hover:underline">Verwijder Familie</button>
                </div>
            </div>

            <div id="activeTimers" class="mb-6 space-y-2"></div>

            <div class="grid grid-cols-3 gap-4 mb-8">
                <button id="voedingBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üçº</span><span class="font-semibold">Voeding</span>
                </button>
                <button id="luierBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üíß</span><span class="font-semibold">Luier</span>
                </button>
                <button id="slaapBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üò¥</span><span class="font-semibold">Slaap</span>
                </button>
                <button id="metingBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üìè</span><span class="font-semibold">Meting</span>
                </button>
                <button id="noiseBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üåä</span><span class="font-semibold">Noise</span>
                </button>
                <button id="songBtn" class="glass-card p-4 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 flex flex-col items-center justify-center text-center">
                    <span class="text-4xl mb-2">üéµ</span><span class="font-semibold">Ninni</span>
                </button>
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Logboek</h2>
                    <button id="summaryBtn" class="bg-purple-500 text-white text-sm font-semibold px-3 py-2 rounded-lg hover:bg-purple-600 transition-colors flex items-center space-x-2">
                        <span>Dag Samenvatting</span>
                        <span class="text-lg">‚ú®</span>
                    </button>
                </div>
                <div id="logbook" class="space-y-3">
                    <p id="emptyLogMessage" class="text-center text-slate-500 dark:text-slate-400 py-4">Nog geen activiteiten gelogd.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copyFeedback" class="hidden">ID gekopieerd!</div>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div id="createFamilyModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-4">Kies een Familie ID</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-4">Kies een unieke en makkelijk te onthouden ID (bv. 'familie-barlas'). Gebruik alleen letters, cijfers en streepjes.</p>
            <input id="createFamilyIdInput" type="text" placeholder="Kies uw unieke ID" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="createIdError" class="text-red-500 mt-2 text-sm hidden">Deze ID is al in gebruik. Kies een andere.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveNewFamilyBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Aanmaken & Starten</button>
            </div>
        </div>
        <div id="voedingModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Flesvoeding Registreren</h3>
            <div class="space-y-4">
                <div>
                    <label for="flesDatum" class="font-semibold mb-1 block text-sm">Datum</label>
                    <input id="flesDatum" type="date" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="flesTijdUur" class="font-semibold mb-1 block text-sm">Tijd</label>
                    <div class="flex items-center space-x-2">
                        <input id="flesTijdUur" type="number" min="0" max="23" placeholder="UU" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                        <span class="font-bold text-slate-500 dark:text-slate-400">:</span>
                        <input id="flesTijdMinuut" type="number" min="0" max="59" placeholder="MM" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                </div>
                <div>
                    <label for="flesMl" class="font-semibold mb-1 block text-sm">Hoeveelheid (ml)</label>
                    <input id="flesMl" type="number" placeholder="ml" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveFles" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Opslaan</button>
            </div>
        </div>
        <div id="luierModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Luier Registreren</h3>
            <div class="grid grid-cols-1 gap-3">
                <button data-type="nat" class="luier-keuze-btn bg-yellow-400 text-white px-4 py-3 rounded-lg text-lg hover:bg-yellow-500">Natte luier</button>
                <button data-type="vies" class="luier-keuze-btn bg-amber-600 text-white px-4 py-3 rounded-lg text-lg hover:bg-amber-700">Vieze luier</button>
                <button data-type="beide" class="luier-keuze-btn bg-red-500 text-white px-4 py-3 rounded-lg text-lg hover:bg-red-600">Beide</button>
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
        </div>
        <div id="metingModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Meting Registreren</h3>
            <div class="space-y-4">
                <div>
                    <label for="gewichtInput" class="font-semibold mb-1 block">Gewicht (gram)</label>
                    <input id="gewichtInput" type="number" placeholder="e.g. 3500" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="lengteInput" class="font-semibold mb-1 block">Lengte (cm)</label>
                    <input id="lengteInput" type="number" placeholder="e.g. 52" class="w-full p-2 border rounded-lg dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="saveMeting" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Opslaan</button>
            </div>
        </div>
        <div id="noiseModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">White Noise</h3>
            <div class="text-center">
                <button id="playNoiseBtn" class="bg-blue-500 text-white font-bold py-4 px-6 rounded-full text-2xl hover:bg-blue-600 transition-colors">
                    ‚ñ∂Ô∏è Play
                </button>
                <p class="text-sm mt-4 text-slate-500 dark:text-slate-400">Laat open om af te spelen</p>
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Sluiten</button>
        </div>
        <div id="summaryModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <span class="text-lg mr-2">‚ú®</span> Dagelijkse Samenvatting
            </h3>
            <div id="summaryContent" class="text-slate-700 dark:text-slate-300 space-y-3 prose dark:prose-invert">
                <!-- Loading indicator and content will go here -->
            </div>
            <button class="modal-close mt-6 w-full bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Sluiten</button>
        </div>
        <div id="confirmDeleteModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Item Verwijderen</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet je zeker dat je dit item definitief wilt verwijderen?</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmDeleteBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verwijder</button>
            </div>
        </div>
        <div id="confirmLeaveModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Familie Verlaten</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet je zeker dat je wilt uitloggen? Je hebt de ID nodig om opnieuw deel te nemen.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmLeaveBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verlaat</button>
            </div>
        </div>
        <div id="confirmDeleteFamilyModal" class="glass-card rounded-2xl shadow-2xl p-6 w-full max-w-sm hidden">
            <h3 class="text-xl font-bold mb-2">Familie Verwijderen</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Weet u zeker dat u deze familie en <strong>alle</strong> bijbehorende gegevens permanent wilt verwijderen? Dit kan niet ongedaan worden gemaakt.</p>
            <div class="flex space-x-2 mt-6">
                <button class="modal-close flex-1 bg-gray-200 dark:bg-slate-700 px-4 py-2 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600">Annuleren</button>
                <button id="confirmDeleteFamilyBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Ja, verwijder definitief</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase en App State
        let db, auth, familyId;
        let logUnsubscribe, timersUnsubscribe, profileUnsubscribe;
        let localTimerInterval = null;
        let audioContext;
        let currentLogs = [];
        let userId;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        // --- SOUND FUNCTIES ---
        let isNoisePlaying = false;
        let noiseNode;
        const playNoiseBtn = document.getElementById('playNoiseBtn');

        function setupAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleWhiteNoise() {
            setupAudioContext();
            if (isNoisePlaying) {
                noiseNode.stop();
                isNoisePlaying = false;
                playNoiseBtn.textContent = '‚ñ∂Ô∏è Play';
            } else {
                const bufferSize = 2 * audioContext.sampleRate;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
                noiseNode = audioContext.createBufferSource();
                noiseNode.buffer = noiseBuffer;
                noiseNode.loop = true;
                noiseNode.connect(audioContext.destination);
                noiseNode.start(0);
                isNoisePlaying = true;
                playNoiseBtn.textContent = '‚è∏Ô∏è Pause';
            }
        }
        playNoiseBtn.addEventListener('click', toggleWhiteNoise);

        // --- LULLABY (NINNI) FUNCTIES ---
        let isLullabyPlaying = false;
        let stopLullabyCallback = () => {};

        const notes = { 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'REST': 0 };
        const lullabyMelody = [
            { note: 'G4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'A4', duration: 0.4 },
            { note: 'G4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'E4', duration: 0.6 }, { note: 'REST', duration: 0.2 },
            { note: 'F4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'G4', duration: 0.4 },
            { note: 'F4', duration: 0.3 }, { note: 'E4', duration: 0.3 }, { note: 'D4', duration: 0.6 }, { note: 'REST', duration: 0.4 },
            { note: 'E4', duration: 0.3 }, { note: 'E4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'G4', duration: 0.4 },
            { note: 'A4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'F4', duration: 0.6 }, { note: 'REST', duration: 0.2 },
            { note: 'E4', duration: 0.3 }, { note: 'F4', duration: 0.3 }, { note: 'G4', duration: 0.3 }, { note: 'F4', duration: 0.4 },
            { note: 'E4', duration: 0.3 }, { note: 'D4', duration: 0.3 }, { note: 'D4', duration: 0.6 }, { note: 'REST', duration: 0.4 }
        ];

        async function playLullaby() {
            setupAudioContext();
            if (isLullabyPlaying) return;
            isLullabyPlaying = true;

            const songBtn = document.getElementById('songBtn');
            const textEl = songBtn.querySelector('span:last-child');
            textEl.textContent = 'Stop Ninni';
            songBtn.classList.add('bg-red-200', 'dark:bg-red-800/50');

            let shouldStop = false;
            stopLullabyCallback = () => { shouldStop = true; };

            for (const part of lullabyMelody) {
                if (shouldStop) break;

                if (part.note !== 'REST') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(notes[part.note], audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + part.duration);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + part.duration);
                }
                await new Promise(resolve => setTimeout(resolve, part.duration * 1000));
            }

            isLullabyPlaying = false;
            stopLullabyCallback = () => {};
            textEl.textContent = 'Ninni';
            songBtn.classList.remove('bg-red-200', 'dark:bg-red-800/50');
        }

        // DOM Elementen
        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeActionsEl = document.getElementById('welcomeActions');
        const initErrorEl = document.getElementById('initError');
        const appScreen = document.getElementById('app');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const logbookEl = document.getElementById('logbook');
        const emptyLogMessage = document.getElementById('emptyLogMessage');
        const activeTimersEl = document.getElementById('activeTimers');
        const modalContainer = document.getElementById('modal-container');
        const modals = {
            createFamily: document.getElementById('createFamilyModal'),
            voeding: document.getElementById('voedingModal'),
            luier: document.getElementById('luierModal'),
            meting: document.getElementById('metingModal'),
            noise: document.getElementById('noiseModal'),
            summary: document.getElementById('summaryModal'),
            confirmDelete: document.getElementById('confirmDeleteModal'),
            confirmLeave: document.getElementById('confirmLeaveModal'),
            confirmDeleteFamily: document.getElementById('confirmDeleteFamilyModal'),
        };
        const copyFeedback = document.getElementById('copyFeedback');
        const mainAppButtons = document.querySelectorAll('#appContent .glass-card button, #appContent #summaryBtn');
        const loadingAppEl = document.getElementById('loadingApp');

        // --- APP INITIALISATIE ---
        document.addEventListener('DOMContentLoaded', () => {
             // Load Firebase Compatibility scripts first, then initialize
             const compatScript = document.createElement('script');
             compatScript.src = "https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js";
             compatScript.onload = () => {
                const authScript = document.createElement('script');
                authScript.src = "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js";
                authScript.onload = () => {
                    const firestoreScript = document.createElement('script');
                    firestoreScript.src = "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js";
                    firestoreScript.onload = initializeAppAndAuth;
                    document.head.appendChild(firestoreScript);
                };
                document.head.appendChild(authScript);
             };
             document.head.appendChild(compatScript);
        });

        function initializeAppAndAuth() {
            if (!firebaseConfig) {
                initErrorEl.innerHTML = `<strong>App kan niet lokaal worden gestart.</strong><br>Deze app heeft een actieve internetverbinding met onze servers nodig om te synchroniseren. Gebruik de app alstublieft via de preview-omgeving waar u hem heeft gekregen, en niet door het .html-bestand direct te openen.`;
                initErrorEl.style.display = 'block';
                welcomeActionsEl.style.display = 'none';
                return;
            }

            try {
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        if (profileUnsubscribe) profileUnsubscribe();
                        const profileRef = db.doc(`artifacts/${appId}/users/${userId}/profile/data`);
                        profileUnsubscribe = profileRef.onSnapshot((docSnap) => {
                            const data = docSnap.data();
                            if (data && data.familyId) {
                                familyId = data.familyId;
                                showApp();
                            } else {
                                familyId = null;
                                showWelcome();
                            }
                        });
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialisatie mislukt:", e);
                initErrorEl.textContent = 'Kon niet verbinden met de server. Controleer je internetverbinding en probeer het opnieuw.';
                initErrorEl.style.display = 'block';
                welcomeActionsEl.style.display = 'none';
            }
        }

        function showWelcome() {
            if (appScreen) appScreen.style.display = 'none';
            if (welcomeScreen) welcomeScreen.style.display = 'flex';
        }

        async function showApp() {
            if (!familyId) return;
            loadingAppEl.style.display = 'block';
            document.getElementById('appContent').style.display = 'none';
            updateButtonState(false);
            
            document.getElementById('familyIdDisplay').textContent = familyId;

            if (welcomeScreen) welcomeScreen.style.display = 'none';
            if (appScreen) appScreen.style.display = 'block';

            if (logUnsubscribe) logUnsubscribe();
            const logsRef = db.collection(`artifacts/${appId}/public/data/families_public/${familyId}/logs`);
            logUnsubscribe = logsRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                currentLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentLogs.sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime();
                });
                renderLog(currentLogs);
                loadingAppEl.style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                updateButtonState(true);
            }, (error) => {
                console.error("Firestore (logs) permission error:", error);
            });

            if (timersUnsubscribe) timersUnsubscribe();
            const timersRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            timersUnsubscribe = timersRef.onSnapshot((docSnap) => {
                const timers = docSnap.data() || {};
                renderActiveTimers(timers);
                updateSlaapButton(timers);
            }, (error) => {
                console.error("Firestore (timers) permission error:", error);
            });
        }
        
        function updateButtonState(isEnabled) {
            mainAppButtons.forEach(btn => {
                btn.disabled = !isEnabled;
                if (isEnabled) {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // --- FAMILIE ID LOGICA ---
        document.getElementById('createFamilyBtn').addEventListener('click', () => {
            openModal(modals.createFamily);
        });

        document.getElementById('saveNewFamilyBtn').addEventListener('click', async () => {
            const idInput = document.getElementById('createFamilyIdInput');
            const newId = idInput.value.trim().toLowerCase();
            const errorEl = document.getElementById('createIdError');

            if (!newId || !/^[a-z0-9-]+$/.test(newId)) {
                errorEl.textContent = 'Gebruik alleen letters, cijfers en streepjes.';
                errorEl.style.display = 'block';
                return;
            }

            const familyDocRef = db.doc(`artifacts/${appId}/public/data/families_public/${newId}`);
            const familyDoc = await familyDocRef.get();
            if (familyDoc.exists) {
                errorEl.textContent = 'Deze ID is al in gebruik. Kies een andere.';
                errorEl.style.display = 'block';
            } else {
                familyId = newId;
                await familyDocRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                const profileRef = db.doc(`artifacts/${appId}/users/${userId}/profile/data`);
                await profileRef.set({ familyId }, { merge: true });
                closeModal();
            }
        });

        document.getElementById('joinFamilyBtn').addEventListener('click', async () => {
            const inputId = document.getElementById('familyIdInput').value.trim();
            if (!inputId) return;
            const familyDocRef = db.doc(`artifacts/${appId}/public/data/families_public/${inputId}`);
            const familyDoc = await familyDocRef.get();
            if (familyDoc.exists) {
                const profileRef = db.doc(`artifacts/${appId}/users/${userId}/profile/data`);
                await profileRef.set({ familyId: inputId }, { merge: true });
            } else {
                const errorEl = document.getElementById('joinError');
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        });

        document.getElementById('copyFamilyId').addEventListener('click', () => {
            navigator.clipboard.writeText(familyId).then(() => {
                copyFeedback.textContent = 'ID gekopieerd!';
                copyFeedback.style.opacity = 1;
                copyFeedback.classList.remove('hidden');
                setTimeout(() => {
                    copyFeedback.style.opacity = 0;
                    setTimeout(() => copyFeedback.classList.add('hidden'), 300);
                }, 2000);
            });
        });

        document.getElementById('leaveFamily').addEventListener('click', () => {
            openModal(modals.confirmLeave);
        });

        document.getElementById('deleteFamily').addEventListener('click', () => {
            openModal(modals.confirmDeleteFamily);
        });

        document.getElementById('confirmLeaveBtn').addEventListener('click', async () => {
            const profileRef = db.doc(`artifacts/${appId}/users/${userId}/profile/data`);
            await profileRef.set({ familyId: null }, { merge: true });
            closeModal();
            showWelcome();
        });

        // --- RENDER FUNCTIES ---
        function renderLog(log = []) {
            logbookEl.innerHTML = '';
            if (log.length === 0) {
                logbookEl.appendChild(emptyLogMessage);
                emptyLogMessage.style.display = 'block';
            } else {
                emptyLogMessage.style.display = 'none';
                let lastDateString = null;

                log.forEach((item, index) => {
                    if (!item.timestamp) return; // Sla items zonder timestamp over

                    const itemDate = item.timestamp.toDate();
                    const itemDateLocaleString = itemDate.toLocaleDateString('nl-BE');

                    if (itemDateLocaleString !== lastDateString) {
                        const dateHeader = document.createElement('div');
                        dateHeader.className = 'text-center text-sm font-semibold text-slate-500 dark:text-slate-400 py-2 my-2 sticky top-0 bg-gray-100/80 dark:bg-slate-900/80 backdrop-blur-sm z-10';

                        const today = new Date();
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);

                        if (today.toLocaleDateString('nl-BE') === itemDateLocaleString) {
                            dateHeader.textContent = 'Vandaag';
                        } else if (yesterday.toLocaleDateString('nl-BE') === itemDateLocaleString) {
                            dateHeader.textContent = 'Gisteren';
                        } else {
                            dateHeader.textContent = itemDate.toLocaleDateString('nl-BE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        }

                        logbookEl.appendChild(dateHeader);
                        lastDateString = itemDateLocaleString;
                    }

                    const div = document.createElement('div');
                    div.className = 'glass-card p-4 rounded-xl flex items-center space-x-4 shadow-md';
                    if (index === 0) div.classList.add('log-item-new');

                    const { icon, text } = getLogItemContent(item);
                    const hours = itemDate.getHours().toString().padStart(2, '0');
                    const minutes = itemDate.getMinutes().toString().padStart(2, '0');
                    const time = `${hours}:${minutes}`;

                    div.innerHTML = `
                        <span class="text-3xl">${icon}</span>
                        <div class="flex-grow">
                            <p class="font-medium">${text}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${time}</p>
                        </div>
                        <button data-id="${item.id}" class="delete-log-item p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-500 hover:text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>`;
                    logbookEl.appendChild(div);
                });
            }
        }

        function getLogItemContent(item) {
            switch(item.type) {
                case 'VOEDING_FLES': return { icon: 'üçº', text: `Flesvoeding: ${item.data.ml} ml` };
                case 'LUIER':
                    const luierText = { nat: 'Natte luier', vies: 'Vieze luier', beide: 'Natte & vieze luier' };
                    return { icon: 'üíß', text: luierText[item.data.type] };
                case 'SLAAP': return { icon: 'üò¥', text: `Slaap: ${formatDuration(item.data.duration)}` };
                case 'METING':
                    let metingText = [];
                    if (item.data.gewicht) metingText.push(`${item.data.gewicht} g`);
                    if (item.data.lengte) metingText.push(`${item.data.lengte} cm`);
                    return { icon: 'üìè', text: `Meting: ${metingText.join(', ')}` };
                default: return { icon: '‚ùì', text: 'Onbekende activiteit' };
            }
        }
        
        function renderActiveTimers(timers = {}) {
            activeTimersEl.innerHTML = '';
            if (localTimerInterval) clearInterval(localTimerInterval);

            if (timers.slaap && timers.slaap.startTime) {
                const startTime = timers.slaap.startTime.toDate();
                const timerEl = createTimerElement('slaap', startTime);
                activeTimersEl.appendChild(timerEl);
                
                localTimerInterval = setInterval(() => {
                    updateTimerDisplay('display-timer-slaap', startTime);
                }, 1000);
            }
        }
        
        function createTimerElement(type, startTime) {
            const id = `timer-${type}`;
            const div = document.createElement('div');
            div.id = id;
            div.className = 'bg-blue-100 dark:bg-blue-900/50 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200 p-3 rounded-lg flex justify-between items-center';
            div.innerHTML = `<span>üò¥ Slaapje bezig</span><span class="font-mono font-semibold" id="display-${id}">00:00:00</span>`;
            return div;
        }
        
        function updateSlaapButton(timers = {}) {
            const slaapBtn = document.getElementById('slaapBtn');
            const textEl = slaapBtn.querySelector('span:last-child');
            if (timers.slaap) {
                slaapBtn.classList.add('bg-red-200', 'dark:bg-red-800/50');
                textEl.textContent = 'Stop Slaap';
            } else {
                slaapBtn.classList.remove('bg-red-200', 'dark:bg-red-800/50');
                textEl.textContent = 'Slaap';
            }
        }

        // --- DATABASE ACTIES ---
        async function addToLog(type, data, customTimestamp = null) {
            const logsRef = db.collection(`artifacts/${appId}/public/data/families_public/${familyId}/logs`);
            const timestamp = customTimestamp ? customTimestamp : firebase.firestore.FieldValue.serverTimestamp();
            await logsRef.add({ timestamp, type, data });
        }

        async function startSlaapTimer() {
            const timersRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            await timersRef.set({ slaap: { startTime: firebase.firestore.FieldValue.serverTimestamp() } });
        }

        async function stopSlaapTimer() {
            const timersRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            const timerDoc = await timersRef.get();
            const timerData = timerDoc.data();
            if (!timerData || !timerData.slaap) return;

            const startTime = timerData.slaap.startTime.toDate();
            const duration = Math.floor((new Date() - startTime) / 1000);
            await addToLog('SLAAP', { duration });
            await timersRef.set({ slaap: null });
        }
        
        async function deleteFamily() {
            if (!familyId) return;
            const familyDocRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}`);
            const profileRef = db.doc(`artifacts/${appId}/users/${userId}/profile/data`);
            
            try {
                // Delete the public family document
                await familyDocRef.delete();
                // Remove the family ID from the user's private profile
                await profileRef.update({ familyId: firebase.firestore.FieldValue.delete() });
                
                closeModal();
                showWelcome();
                
            } catch (error) {
                console.error("Fout bij het verwijderen van de familie:", error);
                // Use a modal or a temporary message instead of an alert
                // For simplicity, we just log it and close the modal.
                closeModal();
            }
        }

        // --- EVENT HANDLERS ---
        document.getElementById('slaapBtn').addEventListener('click', async () => {
            const timersRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}/state/timers`);
            const timerDoc = await timersRef.get();
            if (timerDoc.data()?.slaap) {
                stopSlaapTimer();
            } else {
                startSlaapTimer();
            }
        });
        
        document.getElementById('songBtn').addEventListener('click', () => {
            if (isLullabyPlaying) {
                stopLullabyCallback();
            } else {
                playLullaby();
            }
        });
        
        logbookEl.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-log-item');
            if (deleteButton) {
                const idToDelete = deleteButton.dataset.id;
                document.getElementById('confirmDeleteBtn').dataset.id = idToDelete;
                openModal(modals.confirmDelete);
            }
        });
        
        ['voedingBtn', 'luierBtn', 'metingBtn', 'noiseBtn', 'summaryBtn'].forEach(id => {
            document.getElementById(id).addEventListener('click', () => {
                if(familyId) {
                     openModal(modals[id.replace('Btn','')]);
                }
            });
        });

        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', closeModal));
        modalContainer.addEventListener('click', (e) => { if (e.target === modalContainer) closeModal(); });

        document.getElementById('confirmDeleteBtn').addEventListener('click', (e) => {
            const idToDelete = e.target.dataset.id;
            if (idToDelete) {
                const docRef = db.doc(`artifacts/${appId}/public/data/families_public/${familyId}/logs/${idToDelete}`);
                docRef.delete();
                closeModal();
            }
        });

        document.getElementById('confirmDeleteFamilyBtn').addEventListener('click', deleteFamily);

        document.getElementById('saveFles').addEventListener('click', () => {
            const ml = parseInt(document.getElementById('flesMl').value);
            const hoursInput = document.getElementById('flesTijdUur').value;
            const minutesInput = document.getElementById('flesTijdMinuut').value;
            const dateInput = document.getElementById('flesDatum').value;

            if (ml > 0 && hoursInput !== '' && minutesInput !== '' && dateInput) {
                const hours = parseInt(hoursInput, 10);
                const minutes = parseInt(minutesInput, 10);

                if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
                    const hoursPadded = hoursInput.padStart(2, '0');
                    const minutesPadded = minutesInput.padStart(2, '0');
                    const dateString = `${dateInput}T${hoursPadded}:${minutesPadded}:00`;
                    const customDate = new Date(dateString);

                    addToLog('VOEDING_FLES', { ml }, customDate);
                    closeModal();
                }
            }
        });
        document.querySelectorAll('.luier-keuze-btn').forEach(btn => {
            btn.addEventListener('click', () => { addToLog('LUIER', { type: btn.dataset.type }); closeModal(); });
        });
        document.getElementById('saveMeting').addEventListener('click', () => {
            const gewicht = parseInt(document.getElementById('gewichtInput').value);
            const lengte = parseInt(document.getElementById('lengteInput').value);
            if (gewicht > 0 || lengte > 0) { addToLog('METING', { gewicht: gewicht || null, lengte: lengte || null }); closeModal(); }
        });
        
        function openModal(modal) {
            modalContainer.style.display = 'flex';
            modal.style.display = 'block';
            if (modal.id === 'voedingModal') {
                const now = new Date();
                document.getElementById('flesDatum').value = now.toISOString().split('T')[0];
                document.getElementById('flesTijdUur').value = now.getHours().toString().padStart(2, '0');
                document.getElementById('flesTijdMinuut').value = now.getMinutes().toString().padStart(2, '0');
            }
            if(modal.id === 'summaryModal') {
                generateSummary();
            }
        }

        function closeModal() {
            modalContainer.style.display = 'none';
            Object.values(modals).forEach(m => m.style.display = 'none');
            // Reset inputs
            ['flesMl', 'gewichtInput', 'lengteInput', 'flesTijdUur', 'flesTijdMinuut', 'flesDatum', 'createFamilyIdInput'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
        
        // Dark mode
        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            updateDarkModeIcons(isDark);
        });
        function setupDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark', isDark);
            updateDarkModeIcons(isDark);
        }
        function updateDarkModeIcons(isDark) {
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        }
        
        // Helpers
        function formatDuration(totalSeconds) {
            if (totalSeconds < 0) totalSeconds = 0;
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            let res = '';
            if (h > 0) res += `${h}u `;
            if (m > 0 || h > 0) res += `${m}m`;
            return res.trim() || `${Math.floor(totalSeconds % 60)}s`;
        }
        function updateTimerDisplay(displayId, startTime) {
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            const display = document.getElementById(displayId);
            if(display) display.textContent = `${h}:${m}:${s}`;
        }

        // --- GEMINI API FUNCTIE ---
        async function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `<p>Een momentje, ik analyseer de dag van Barlas...</p>`;

            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
            const recentLogs = currentLogs.filter(log => log.timestamp && log.timestamp.toDate() > twentyFourHoursAgo);

            if (recentLogs.length < 3) {
                summaryContent.innerHTML = `<p>Er zijn nog niet genoeg activiteiten gelogd in de laatste 24 uur om een goede samenvatting te maken. Probeer het later opnieuw!</p>`;
                return;
            }

            const logText = recentLogs.map(log => {
                const date = log.timestamp.toDate();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const time = `${hours}:${minutes}`;
                return `- ${time}: ${getLogItemContent(log).text}`;
            }).join('\n');

            const systemPrompt = "Je bent een vriendelijke en ondersteunende baby-assistent. Geef een korte, positieve en geruststellende samenvatting van de dag van een baby op basis van het logboek. Spreek de ouders direct aan (met 'jullie'). Noem de totale slaapduur, het aantal voedingen en eventuele opvallende patronen. Gebruik eenvoudige taal. Geef geen medisch advies.";
            const userQuery = `Hier is het logboek van de baby Barlas voor de afgelopen 24 uur. Maak alsjeblieft een samenvatting voor de ouders.\n\n${logText}`;
            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    })
                });

                if (!response.ok) {
                    throw new Error(`API verzoek mislukt met status: ${response.status}`);
                }

                const result = await response.json();
                const summary = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (summary) {
                    summaryContent.innerHTML = summary.replace(/\n/g, '<br>');
                } else {
                    summaryContent.innerHTML = `<p>Sorry, ik kon op dit moment geen samenvatting genereren. Probeer het later opnieuw.</p>`;
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                summaryContent.innerHTML = `<p>Oeps, er ging iets mis met de verbinding. Controleer je internet en probeer het opnieuw.</p>`;
            }
        }
    </script>
</body>
</html>
